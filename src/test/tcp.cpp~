#include <sys/socket.h>
#include <sys/ioctl.h>
#include <linux/if_packet.h>
#include <linux/if_ether.h>
#include <linux/if.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <iostream>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <errno.h>
#include <unistd.h>
#include <pthread.h>
#include <thread>
using namespace std;

struct sockaddr_in addr_;
int sock;
string id = "00000001";
unsigned char crt[162];
unsigned char pcrt[162] = {
0x02,0x1a,0x37,0x15,0x9b,0x0f,0xfc,0x6b,0x08,0x92,0x6b,0xc3,0x4b,0x73,0x3b,0xcb,0xab,0x73,0x43,0xab,0x63,0x4b,0x0b,0x72,0x01,0xae,0x66,0x3c,0xaf,0x6d,0xdb,0x1e,0x1d,0xea,0x47,0x72,0x5c,0xb3,0x58,0x5f,0x02,0xaf,0xd4,0x2d,0xbe,0xff,0x79,0x81,0xb2,0xf9,0x72,0xd9,0xa3,0x78,0xbc,0x00,0x78,0xfa,0x63,0xdd,0x87,0x35,0xb1,0xed,0xdd,0x20,0xdb,0x93,0x30,0x31,0xd7,0x08,0xf6,0x20,0x8a,0x00,0x38,0xd8,0xb6,0x9c,0xe6,0x3b,0x28,0x7b,0x16,0xab,0xa6,0x29,0x29,0x1c,0xc9,0x2b,0x87,0x1c,0xd1,0xf5,0x87,0x4f,0x22,0xfa,0xa2,0x3f,0x6c,0x90,0x59,0x00,0x9c,0xf5,0x8f,0x61,0x83,0x8f,0x5b,0x9b,0x09,0xa2,0x15,0xd4,0x40,0x32,0xf2,0xdd,0xdb,0x2f,0x05,0x92,0xa2,0xf7,0xe5,0xeb,0x17,0x7c,0x80,0x29,0x38,0x88,0x32,0x0e,0x2a,0xea,0x28,0x40,0x43,0xb6,0x04,0x0b,0x65,0xb3,0xc6,0x34,0x31,0x84,0xeb,0x2b,0x65,0xcf,0x5c,0x7a,0xe8,0xc3,0xf3,0x00
};
unsigned char rcrt[162] ={
0x02,0x11,0xd3,0x2c,0x8a,0xd3,0x8b,0x76,0x39,0xc2,0x6b,0xc3,0x4b,0x73,0x3b,0xcb,0xab,0x73,0x43,0xab,0x63,0x4b,0x0b,0x72,0x05,0xcb,0xa9,0xfc,0x10,0x27,0x68,0x94,0xd7,0x2e,0x96,0xc5,0x06,0x40,0x31,0xc2,0x90,0x66,0x97,0xa0,0x30,0x9e,0x6c,0xe1,0x11,0xc9,0xc2,0x50,0xde,0xb4,0x44,0x7d,0x16,0x06,0x09,0x26,0x52,0xc9,0xba,0x04,0xba,0xf6,0x2a,0xf3,0x02,0x8a,0xe6,0x0e,0x78,0x03,0xa3,0x90,0x03,0x36,0xf0,0x86,0xeb,0x03,0x20,0xa8,0x32,0xc4,0x62,0x3b,0x89,0x1c,0xc9,0x2c,0x12,0x1c,0xd1,0xf6,0x12,0x3b,0x02,0x3f,0xe7,0xc9,0xd1,0x5b,0x13,0x08,0xf4,0xf2,0x4d,0xe5,0xba,0xea,0xd7,0x3a,0x29,0x9e,0x99,0xa7,0x0b,0xe7,0xb3,0xa8,0xd1,0xc2,0xe9,0x3b,0x82,0x0d,0xc3,0xfa,0x71,0xb3,0xe2,0x03,0x7b,0xf0,0x2b,0x2f,0xf8,0x9e,0x79,0x21,0xad,0x05,0x72,0x32,0xa9,0xa6,0x1a,0x20,0x07,0x9e,0x78,0xa9,0xae,0xe4,0xfb,0x93,0x8f,0xe2,0xa5,0x00};
unsigned char ecrt[162] = {
0x02,0x1a,0x6c,0xfd,0x6d,0x56,0x18,0xcc,0x91,0x10,0x6b,0xc3,0x4b,0x73,0x3b,0xcb,0xab,0x73,0x43,0xab,0x63,0x4b,0x0b,0x72,0x04,0x6f,0x71,0xcb,0x16,0xf8,0xd1,0x79,0x80,0xae,0x84,0x33,0x30,0x71,0x0e,0xb8,0x09,0x72,0x34,0xe5,0x40,0x42,0x6f,0x8a,0xdf,0x0d,0x0a,0xb2,0x43,0x78,0xcc,0xc6,0x79,0x98,0x7a,0x95,0x9b,0xa0,0x36,0xeb,0x89,0x11,0xd6,0x82,0xe7,0x94,0x83,0xba,0x72,0x87,0x0e,0xc1,0xee,0xec,0xa1,0x9b,0x00,0x85,0x07,0x2b,0xf7,0xba,0x06,0x10,0xa9,0x1c,0xc9,0x27,0x11,0x2f,0x98,0xae,0x11,0x35,0xa0,0x8f,0x7f,0xe5,0xb4,0xfe,0xe1,0x31,0xe4,0x2f,0x05,0x12,0x44,0x85,0x88,0x0e,0xaf,0x94,0xf1,0x32,0x58,0x4d,0x94,0x1c,0xd0,0xc8,0x72,0x6d,0x86,0x59,0xc5,0x59,0x62,0xe1,0x79,0x75,0x56,0x03,0xc9,0x0f,0xd6,0xfa,0x23,0x7b,0x36,0x0e,0x89,0xd3,0x8c,0x4a,0x25,0xf5,0xcb,0x30,0xe2,0xdd,0x0d,0x07,0xea,0x9b,0xa7,0x88,0x81,0x00

};
int create_socket(){

    if ((sock = socket(AF_INET, SOCK_STREAM, 0)) == -1) {
        printf("CreateSocket: socket() Failed!\n");
        return -1;
    } 

    bzero(&addr_,sizeof(struct sockaddr_in));
    addr_.sin_family = AF_INET;
    addr_.sin_addr.s_addr = inet_addr("127.0.0.1");
    addr_.sin_port = htons(6666); 

    return 0;
}
unsigned char* IntToUnsignedChar(unsigned int num){
    unsigned char *ret = (unsigned char* )malloc(4);
    if (!ret) {
        printf("IntToUnsignedChar malloc fail\n");
        return NULL;
    }
    ret[0] = num >> 24;
    ret[1] = num >> 16;
    ret[2] = num >> 8;
    ret[3] = num;
    return ret;
}
unsigned int UnsignedCharToInt(unsigned char* num){
    if (!num) {
        return 0;
    }
    int ret = num[3];
    ret += num[2] << 8;
    ret += num[1] << 16;
    ret += num[0] << 24;
    return ret;
}
void print_buffer(unsigned char* buffer, size_t blen){
    printf("\n");
    for (int i=0; i<blen; i++) {
        printf("0x%02x ", *(buffer+i));
    }
    printf("\n");
}
unsigned char CalculateBCC(unsigned char* buff, int len){
    if (buff == NULL) {
        return 0x00;
    }

    unsigned char bcc= *buff;
    for(int i=1; i<len; i++){
        bcc^=*(buff+i);
    }
    return bcc;
}
int MessageDecode(unsigned char* buffer, size_t blen, unsigned char* cmd, unsigned char** data, size_t* dlen){
    if (buffer == NULL) {
        return -1;
    }

    unsigned char head[2] = {0xff,0xff};
    if (memcmp(buffer, head, 2) != 0) {
        printf("MessageDecode verify msg head fail\n");
        return -1;
    }
    if(*(buffer+blen-2) !=  CalculateBCC(buffer+2, blen-4)){
        printf("MessageDecode:  cheack bcc Failed!\n");
        return -1;
    }
    unsigned char length[4];
    memcpy(length, buffer+2, 4);
    unsigned int length_ = UnsignedCharToInt(length);
    *dlen = length_-1;
	cout<<*dlen<<endl;
    unsigned char* data_ = (unsigned char*)malloc(*dlen);
    if (!data_) {
        printf("MessageDecode malloc data_ fail\n");
        return -1;
    }
    unsigned char cmd_;
    memcpy(&cmd_, buffer+2+4, 1);
    *cmd = cmd_;

    memcpy(data_, buffer+8, *dlen);
    *data = data_;
    return -1;
}

int MessageEncode(unsigned char cmd, unsigned char* data, size_t dlen, unsigned char** msg, size_t* mlen){
    if (data == NULL) {
        return -1;
    }
    unsigned char *msg_ = (unsigned char *)malloc(dlen + 10);
    if (!msg_) {
        printf("MessageEncode: malloc msg fail\n");
        return -1;
    }
    int len = 0;
    memset(msg_+len, 0xff, 2);
    len+=2;
    unsigned int length = 1+dlen;
    unsigned char* length_ = IntToUnsignedChar(length);
    if (!length_) {
        printf("MessageEncode: IntToUnsignedChar fail\n");
        return -1;
    }
    memcpy(msg_+len, length_, 4);
    len+=4;
    memset(msg_+len, cmd, 1);
    len+=1;
    memcpy(msg_+len, data, dlen);
    len+=dlen;
    unsigned char bcc = CalculateBCC(msg_+2, len-2);
    memset(msg_+len, bcc, 1);
    len+=1;
    memset(msg_+len, 0xff, 1);
    len+=1;
    *msg = msg_;
    *mlen = len;
    free(length_);
    return 0;
}

void Recv(){
        unsigned char buffer[1024] = {};
        size_t len = 0;
while(true){
        unsigned char *data = NULL;
        size_t dlen = 0;
        if((len = recv(sock, (void*)buffer, 1024, 0)) <= 0){
             printf("Handler: recv msg fail\n");
             return; 
        }
	printf("recv: \n");
	print_buffer(buffer, len);
/*
	unsigned char cmd;
	MessageDecode(buffer, len, &cmd, &data, &dlen);
	printf("data: \n");
	print_buffer(data, dlen);

	unsigned char pri[32];
	memcpy(pri, data, 32);
	memcpy(crt, data+32, 162);
	printf("rcrt: \n");
	print_buffer(crt, 162);
	printf("pri: \n");
	print_buffer(pri, 32);
*/
	free(data);

usleep(1);
}

}




int main(){
	if (create_socket() != 0) {
		printf("Start: create_socket fail\n");
		return 0;
	}


 	if (connect(sock, (struct sockaddr *)&addr_,sizeof(struct sockaddr_in)) == -1){
		perror("connect error"); 
		exit(1);
     	} 
	thread t(Recv);
	t.detach();

	//unsigned char data[8];
	//memcpy(data, id.c_str(), 8);
	unsigned char *msg = NULL;
	size_t mlen = 0;
/*
size_t l = 162*2+1;
unsigned char c4[l];
memset(c4, 0x02, 1);
memcpy(c4+1, pcrt, 162);
memcpy(c4+1+162, ecrt, 162);
	MessageEncode(0x04, c4, l, &msg, &mlen);

	if(send(sock, msg, mlen, 0) == -1){
		perror("send fail");
	}
	printf("send: \n");
	print_buffer(msg, mlen);
	free(msg);
*/
	

	MessageEncode(0x05, ecrt, 162, &msg, &mlen);
	if(send(sock, msg, mlen, 0) == -1){
		perror("send fail");
	}
	printf("send: \n");
	print_buffer(msg, mlen);
	free(msg);

	getchar();
return 0;
}

